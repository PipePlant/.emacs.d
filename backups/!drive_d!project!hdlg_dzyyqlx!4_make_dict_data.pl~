use warnings;
use strict;
use Encode;
use Data::Dumper;
use JSON;
use feature qw(say);

my $json = new JSON;

my $detials_file = "./final_data/hdlg_dzyyqlx_details_full.txt";
my $dict_file = "./final_data/hdlg_dzyyqlx.dict.txt";

open my $DETAILS ,"<", $detials_file or die $!;
open my $DICT ,">", $dict_file or die $!;

while (<$DETAILS>) {
    chomp;
    my $line = $_;
    $line =~ /"key":".+?kcb(\d+).+?"/;
    my $index = $1;
    $line =~ /.*\t.*\t(.*)/;
    my %item = %{$json->decode($1)};

    my %obj = ();
    my $key = $item{"key"};
    my $uwid = $item{"uwid"};
    $obj{"key"} = $key;
    $key =~ /(.*)_kc.+?$/;
    $obj{"parent_id"} = $1;
    $obj{"uwid"} = $uwid;
    $obj{"prev"} = $item{"prev"} if exists $item{"prev"};
    $obj{"next"} = $item{"next"} if exists $item{"next"};
    $obj{"audio"} = ${$item{"body"}}{"audio"} if exists $item{"audio"};
    if ($index == 1) {
        $obj{"word"} = ${$item{"body"}}{"word"};
        $obj{"def"} = ${$item{"body"}}{"def"};
        $obj{"img"} = ${$item{"body"}}{"img"} if exists ${$item{"body"}}{"img"};
    }elsif ($index == 2) {
        $obj{"word"} = ${$item{"body"}}{"phrase"};
        $obj{"def"} = ${$item{"body"}}{"def"};
    }elsif ($index == 3 or
            $index == 4) {
        $obj{"word"} = ${$item{"body"}}{"cont"};
        $obj{"def"} = ${$item{"body"}}{"tran"};
    }else {
        $obj{"word"} = ${$item{"body"}}{"note"}[0];
        $obj{"def"} = "";
    }
    say $DICT $key."\t".$uwid."\t".$json->encode(\%obj);
}

close $DETAILS;
close $DICT;
