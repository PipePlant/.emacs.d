use warnings;
use strict;
use Encode;
use Data::Dumper;
use JSON;
use feature qw(say);

my $json = new JSON;

my $in_file = "./OLD/tmpdocument/hdlg_dzyyqlx.show.txt";
my $out_file = "./tmp_file/hdlg_dzyyqlx_tmp_details.txt";

open my $IN ,"<", $in_file or die $!;
open my $OUT ,">", $out_file or die $!;

my %item = ();
my $flag = 0;
while (<$IN>) {
    my $line = $_;

    # ```chapter
    if ($line =~ /^Chapter \d+: (.*) ([\x80-\xff ]+)/) {
        $item{"title"} = $1;
        $item{"word"} = $2;
        $item{"type"} = "l_a";
        next;
    }
    if ($line =~ /(.*cover\.jpeg)/) {
        $item{"img"} = $1;
        say $OUT $json->encode(\%item);
        %item = ();
        next;
    }

    #```unit```
    if ($line =~ /((Vocabulary)|(Key Terms)|(Conversations)|(Useful Expressions))/) {
        my $word = $1;
        if ($word eq "Vocabulary") {
            $flag = 1;
        }elsif ($word eq "Key Terms") {
            $flag = 2;
        }elsif ($word eq "Conversations") {
            $flag = 3;
        }elsif ($word eq "Useful Expressions") {
            $flag = 4;
        }
        $item{"word"} = $word;
        $item{"type"} = "l_b";
        say $OUT $json->encode(\%item);
        %item = ();
        next;
    }
}

close $IN;
close $OUT;
