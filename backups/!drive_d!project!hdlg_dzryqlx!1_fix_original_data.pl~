use warnings;
use strict;
use Encode;
use Data::Dumper;
use JSON;
use feature qw(say);

my $in_file = "./tmp_data/hdlg_dzryqlx_tidy_data.txt";
my $out_file = "./tmp_data/hdlg_dzryqlx_import_data.txt";
my $log_file = "./tmp_data/log.txt";

# ---------
my $buff;
{
    local $/ = undef;
    open my $IN ,"<", $in_file or die $!;
    $buff = <$IN>;
    close $IN;
}
$buff =~ s/<\/hriyu>\n<hriyu>//g;
$buff =~ s/(<\/buchongb>\n)(<gsz>)/$1<buchongby><\/buchongby>$2/g;
$buff =~ s/(（常用表达）<\/part>\n)(==========================\n)/$1==========================================\n01 <bbiaoti> <\/bbiaoti>\n$2/g;
$buff =~ s/(在杂货店买水果)  <\/hbioatiz>/\n<hbiaotiz>$1<\/hbiaotiz>/;
$buff =~ s/<\/hbiaotiz>\n<hbiaotiz>//g;
$buff =~ s/<\/hbiaoti><hbiaotiz>(.+?)<\/hbiaoti>/<\/hbiaoti>\n<hbiaotiz>$1<\/hbiaotiz>/g;
$buff =~ s/<hbiaotiz>(.+?) (这柜台是卖……的吗？<\/hbiaotiz>)/<hbiaoti>$1<\/hbiaoti>\n<hbiaotiz>$2/;
$buff =~ s/(<buchongb>).*関.*税.*(<\/buchongb>)/$1関税申告書$2/;
$buff =~ s/<br \/>//g;
$buff =~ s/(<word>バスマット<\/word>\n.+?<\/def>)\n(<word>.+?槽<\/zy3><\/zy1><\/word>\n.+?<\/def>)\n/$2\n$1\n/;
$buff =~ s/<\/rmriwen>\n<rmriwen>//;

my @textData = split /\n/,$buff;

# ---------
open my $OUT ,">", $out_file or die $!;
open my $LOG ,">", $log_file or die $!;

my %wordList = ();
my @wordData = ();
my $wordCount = 0;
my $flag1 = 0;
my $flag2 = 1;
foreach my $line (@textData) {
    $line =~ s/^(<word>.*)<\/def>$/$1<\/word>/;
    $line =~ s/<\/gjc><gjcz>/<\/gjc>\n<gjcz>/;
    $line =~ s/<hbiaotiz><\/hbioatiz>//g;
    $line =~ s/^(<hbiaoti>.*)<\/hbioatiz>$/$1<\/hbiaoti>/;
    $line =~ s/^(<briwen>.*)<\/bzhongwen>$/$1<\/briwen>/;
    $line =~ s/^(<briwen>.*)<\/brigwen>$/$1<\/briwen>/;
    $line =~ s/^(<briwen>.*[^>]$)/$1<\/briwen>/;
    $line =~ s/<wimg>shutterstock_69626287_opt.jpeg<\/wimg>//g;
    $line =~ s/(<def>紫色<\/def>)/$1\n<wimg>zhanque1.jpeg<\/wimg>/g;
    $line =~ s/shutterstock_203240881日本加油站_opt.jpeg/shutterstock_203240881_opt\.jpeg/;
    $line =~ s/(时间表<\/buchongb>)/$1\n<buchongby><\/buchongby>/;
    $line =~ s/(游签证Tips<\/buchongb>)/$1\n<buchongby><\/buchongby>/;
    
    if ($line =~ /<wimg>p.56_opt.jpeg<\/wimg>/) {
        $flag1++;
        $line = "<wimg>p.56_opt_50.jpeg</wimg>" if $flag1 == 1;
        $line = "<wimg>p.56_opt_10.jpeg</wimg>" if $flag1 == 2;
        $line = "<wimg>p.56_opt_5.jpeg</wimg>" if $flag1 == 3;
    }
    if ($line =~ /<wimg>015_opt.jpeg<\/wimg>/) {
        $line = "<wimg>015_opt_1.jpeg</wimg>" if $flag2;
        $flag2 = 0;
    }
    
    next if $line eq "";

    if ($line =~ /^<bzhongwen>/) {
        $line =~ s/<bzhongwen>//g;
        $line = "<bzhongwen>".$line;
    }elsif ($line =~ /^<(.+?)>(.*)<\/(.+?)>$/) {
        my $tag1 = $1;
        my $data = $2;
        my $tag2 = $3;
        if ($data eq "") {
            next;
        }elsif ($tag1 ne $tag2) {
            say $LOG $line;
        }
    }
	say $OUT $line;
}

close $OUT;
close $LOG;
