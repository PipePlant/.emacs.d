use warnings;
use strict;
use JSON;
use Data::Dumper;
use feature qw(say);

my $in = "./original_data/ps_schools_16Feb_original.txt";
my $out = "./schools_list/primaryschool_json.txt";

my $jsonCoder = new JSON;

open IN ,"< $in", or die $!;
open OUT ,"> $out", or die $!;

my @object;
my @regionPrvc;
my %regionPrvcHash;
my @regionCity;
my %regionCityHash;
my @regionArea;
my %regionAreaHash;
my @schools;
my $num = 1;

my @municipality_id = qw(北京 天津 上海 重庆);
my @province_list = qw(黑龙江 吉林 辽宁 山东 山西 陕西 河北 河南 湖北 湖南 海南 江苏 江西 广东 广西 云南 贵州 四川 内蒙古 宁夏 甘肃 青海 西藏 新疆 安徽 浙江 福建 香港 澳门 台湾);

my $flag = 0;

while (<IN>) {

	my $line = $_;
	my $item = $jsonCoder->decode($line);
	my %item = %{$item};

	if (exists $item{"state"}){

		#====================================
		if (@schools) {
			my @tmpArray = @schools;
			$regionAreaHash{"schools"} = \@tmpArray;
			undef @schools;

			my %tmpHash = %regionAreaHash;
			push @regionArea,\%tmpHash;
			undef %regionAreaHash;
		}
		#====================================
		 
		if ($item{"text"} ~~ @municipality_id) {
			#直辖市		

			addInfo($flag);

			$regionPrvcHash{"province"} = $item{"text"};
			$regionPrvcHash{"id"} = $item{"id"};
			$flag = 0;
			
		}elsif ($item{"text"} ~~ @province_list) {
			#省
			
			addInfo($flag);

			$regionPrvcHash{"province"} = $item{"text"};
			$regionPrvcHash{"id"} = $item{"id"};
			$flag = 1;

		}elsif ($item{"id"} =~ /\d{4}00/) {
			#市
			if (@regionArea) {
				my @tmpArray = @regionArea;
				$regionCityHash{"areas"} = \@tmpArray;
				undef @regionArea;

				my %tmpHash = %regionCityHash;
				push @regionCity,\%tmpHash;
				undef %regionCityHash;
			}

			$regionCityHash{"city"} = $item{"text"};
			$regionCityHash{"id"} = $item{"id"};

		}else {
			#区 县
			my $tmp = $item{"text"};
			$tmp =~ s/　+//g;
			$tmp =~ s/ +//g;
			$regionAreaHash{"area"} = $tmp;
			$regionAreaHash{"id"} = $item{"id"};
			$num = 1;
		}

	}else {
		#学校
		my %tmpHash;
		my $idNum = sprintf "%04s",$num++;
		$tmpHash{"school"} = $item{"cname"};
		$tmpHash{"id"} = $item{"code"}*100000+$idNum+10000;
		push @schools,\%tmpHash;
	}

}

addInfo($flag);

say OUT $jsonCoder->encode(\@object);
# say OUT Dumper(\@object);

close IN;
close OUT;

sub addInfo {
	my ($flag) = @_;

	if ($flag) {
		#~~~~~~~~~~省级的push~~~~~~
		if (@regionArea) {
			my @tmpArray = @regionArea;
			$regionCityHash{"areas"} = \@tmpArray;
			undef @regionArea;

			my %tmpHash = %regionCityHash;
			push @regionCity,\%tmpHash;
			undef %regionCityHash;
		}

		if (@regionCity) {
			my @tmpArray = @regionCity;
			$regionPrvcHash{"cities"} = \@tmpArray;
			undef @regionCity;

			my %tmpHash = %regionPrvcHash;
			push @object,\%tmpHash;
			undef %regionPrvcHash;
		}

	}else{
		#~~~~~~~~~~直辖市的push~~~~~~
		if (@regionArea) {
			my @tmpArray1 = @regionArea;
			$regionCityHash{"city"} = $regionPrvcHash{"province"};
			$regionCityHash{"id"} = $regionPrvcHash{"id"};
			$regionCityHash{"areas"} = \@tmpArray1;
			my %tmpHash1 = %regionCityHash;
			push @regionCity,\%tmpHash1;
			undef @regionArea;

			my @tmpArray2 = @regionCity;
			$regionPrvcHash{"cities"} = \@tmpArray2;
			undef @regionCity;

			my %tmpHash = %regionPrvcHash;
			push @object,\%tmpHash;
			undef %regionPrvcHash;
		}

	}

}
