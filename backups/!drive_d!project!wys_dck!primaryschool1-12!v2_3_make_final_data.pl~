use strict;
use warnings;
use Data::Dumper;
use Encode;
use JSON;
use feature qw(say);

my $josn = new JSON;

my @tidyFiles = glob "./v2_data/tmp_data/*_tidy.txt";
my $logFile = "./v2_data/final_data/audio_log.txt";

open my $LOG ,">", $logFile or die $!;
foreach my $tidyFile (@tidyFiles) {
    $tidyFile =~ /(1l(\d+))/;
    my $fullBookNum = $1;
    my $bookNum = $2;
    my $finalFile = "./v2_data/final_data/".$fullBookNum."_additional_final.txt";
    my $word_list_file = "./v2_data/word_list/1l".$bookNum."_word_list.txt";

    my %wordIndex = ();
    open my $WORDLIST ,"<", $word_list_file or die $!;
    while (<$WORDLIST>) {
        $_ =~ /(.*)\t.*\t(.*)/;
        $wordIndex{$1} = $2;
    }
    close $WORDLIST;

    open my $TIDY ,"<", $tidyFile or die $!;
    open my $FINAL ,">", $finalFile or die $!;

    my $word = "";
    my @object = ();
    my $audioNum = 0;
    while (<$TIDY>) {
        my $line = $_;
        
        if ($line =~ /<-> (.*)/) {
            $word = $1;
        } elsif ($line =~ /(.+?)\t(.*)/) {
            my $sentence = $1;
            my $tmpAudio = $2;
            if ($tmpAudio
                and $tmpAudio !~ /zanque/) {
                $sentence =~ s/\[\*\]//g;
                $sentence =~ s/^ +| +$//g;
                my $audio = "bookdata-".sprintf("%04s",++$audioNum).".mp3";
                my %bookData = ();
                $bookData{"sentence"} = $sentence;
                $bookData{"audio"} = $audio;
                push @{\@object},\%bookData;
                say $LOG $fullBookNum."/".$tmpAudio.".mp3\t".sprintf("%02s",$bookNum)."-".sprintf("%02s",$wordIndex{$word})."_".$audio;
            }
        }
        if ($line =~ /={3,}/ or
            eof) {
            # ```print```
            say $FINAL $word."\t".$josn->encode(\@object) if $word;
            $word = "";
            @object = ();
        } 
    }
    
    close $TIDY;
    close $FINAL;
}
close $LOG;
