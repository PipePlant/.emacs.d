use strict;
use warnings;
use Data::Dumper;
use JSON;
use LWP::Simple;
use URI::Escape;
use utf8;
use feature qw (say);

my $audio_folder = "./";

my $timeNow = localtime(time);

## windows有被保留的设备名无法命名需要先判断CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4,
### COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, and LP
# my $shebei = "CON, PRN, AUX, NUL, COM1, COM2, COM3, COM4,COM5, COM6, COM7, COM8, COM9, LPT1, LPT2, LPT3, LPT4, LPT5, LPT6, LPT7, LPT8, LP";
# my @shebei = split(", ",$shebei);

my $data_file = "./synthesis_audio.txt";
open my $DATA ,"<", $data_file or die $!;

my @dataArray;
my %newNameList = ();
while (<>) {
    chomp;
    $_ =~ /(.*)\t(.*)/;
    push @dataArray,$1;
    $newNameList{$1} = $2;
}
close $DATA;
print Dumper\@dataArray;
exit;

for (my $i = 0; $i < @dataArray; $i++) {

    my $url = "http://172.18.18.44:8889/voice?text=".uri_escape($dataArray[$i]);
    # my $url = "http://172.18.18.227:8889/voice?text=".uri_escape_utf8($dataArray[$i]);
    
    my $status = getstore("$url","$audio_folder/"."$i.mp3");

    print $status."\t"."$i+1"."\t".@dataArray."\t".$newNameList{$dataArray[$i]}.".mp3"."\n";
    
    # 404错误重启机器等待2分钟
    # if($status == 404) {

    #     getstore("http://172.18.18.44:8889/reboot", "dummy.txt");
    #     sleep 60 * 2;
    #     $i--;
    # }

    # 声音合成失败
    if($status == 501) {

    }

    # 超时等10秒
    elsif($status == 500) {

        sleep 10;
        $i--;
    }

    # 声音合成正确
    if ($status == 200) {

        next;
    }

    # 未知情况如程序错误
    else {

        sleep 30;
    }
}