use warnings;
use strict;
use Encode;
use Data::Dumper;
use JSON;
use File::stat;
use File::Basename;
use feature qw(say);

my $dtype = "shjd_hychsccj";
my $tmp_file = "./tmp_data/".$dtype."_tmp_data.txt";
my $tidy_file = "./tmp_data/".$dtype."_tidy_data.txt";
my $img_path = "./original_data/shjd_hychsccj-web-resources/image/";

my %staus = ("1103" => "[近]",
             "1117" => "[近]",
             "1116" => "[例]",
             "1121" => "[例]",
             "1115" => "[关]",
             "1125" => "[关]",
             "1212" => "[关]",
             "1126" => "[反]",
             "1132" => "[反]",);
my %info = ();
GetInfoFromImg(\%info);
ProcessTidyData();

sub GetInfoFromImg {
    my $info = shift;
    my @imgs = glob $img_path."*";
    foreach my $img (@imgs) {
        my $size = stat($img)->size;
        my $basename = basename $img;
        if (exists $staus{$size}) {
            ${$info}{$basename} = $staus{$size};
        }
    }
};

sub ProcessTidyData {
    open my $TMP ,"<", $tmp_file or die $!;
    open my $TIDY ,">", $tidy_file or die $!;

    my $prevLine = "";
    my $stausChar = "";
    while (<$TMP>) {
        chomp;
        my $line = $_;

        # delete blank lines
        next if $prevLine eq $line;

        # process staus
        if ($line =~ /^(\d+\.jpg)/) {
            my $imgInfo = $1;
            $stausChar = $info{$imgInfo};
            $line =~ s/$imgInfo/$stausChar\t/g;
        } else {
            if ($stausChar) {
                if ($line) {
                    $line = $stausChar."\t\t".$line;
                } else {
                    $stausChar = "";
                }
            }
        }
        
        $prevLine = $line;
        say $TIDY $line;
    }
    
    close $TMP;
    close $TIDY;
};
