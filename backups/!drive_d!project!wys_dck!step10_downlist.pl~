use strict;
use warnings;
use JSON;
use Data::Dumper;
use Encode;
use File::stat;
use File::Find;
use feature qw (say);

my $jsonCode = new JSON;
my @downList;

# my $des = "./primaryschool1-12/wys_dckxxfo.studydescription.txt";
# my $out = "./primaryschool1-12/wys_dckxxfo.download_packagelist.txt";
# my $folder = "./wys_dckxxfo_kc_lixian_gzip/";

# my $des = "./primaryschool1-8/wys_dckxxft.studydescription.txt";
# my $out = "./primaryschool1-8/wys_dckxxft.download_packagelist.txt";
# my $folder = "./wys_dckxxft_kc_lixian_gzip/";

my $des = "./juniorschool/wys_dckcz.studydescription.txt";
my $out = "./juniorschool/wys_dckcz.download_packagelist.txt";
my $folder = "./wys_dckcz_kc_lixian_gzip/";

# my $des = "./highschool/wys_dckgz.studydescription.txt";
# my $out = "./highschool/wys_dckgz.download_packagelist.txt";
# my $folder = "./wys_dckgz_kc_lixian_gzip/";

open DES ,"< $des", or die $!;
open OUT ,"> $out", or die $!;

my $unitWord = "";

while (<DES>) {

	my %downUnit;
	$_ =~ /(.*)\t(.*)/;
	my $name = $1;
	my $data = $jsonCode->decode($2);

	if ($name =~ /kca\d+$/) {

		$unitWord = ${$data}{"word"};
	}elsif ($name =~ /kcb(\d+)$/) {

		my $num = int $1;
		$downUnit{"word"} = "$unitWord 第$num单元";
		$downUnit{"id"} = ${$data}{"id"};
		push @downList,\%downUnit;
	}
}

close DES;

my @tgzFileFolder = glob "./$folder/*.tgz";;

foreach my $var (@tgzFileFolder) {
	
	my $size = stat($var)->size();
	$var =~ s/.*\/\/(.+?)$/$1/g;

	my $tmpHash = shift @downList;
	${$tmpHash}{"packagename"} = $var;
	${$tmpHash}{"size"} = $size;
	push @downList,$tmpHash;
}
say OUT $jsonCode->encode(\@downList);

close OUT;