use strict;
use warnings;
use Data::Dumper;
use feature qw(say);
require FormatItem;

package XmlItem;

sub SelectDHBodyData {
    my ($data) = @_;

    my %obj = ();
    # *** body layer a ***
    if ($data =~ s/<word(.+?)<\/word>//) {
        my $tmpWord = $1;
        # ```tmpKey & word```
        if ($tmpWord =~ s/ search="(.+?)">(.*)//) {
            $obj{"tmpKey"} = $1;
            $obj{"word"} = $2;
        }
        if ($tmpWord =~ s/ homo="(\d+)"//) {
            $obj{"word"} .= "<up>".$1."</up>";
        }
        if ($tmpWord =~ / inflection="\*"/) {
            $obj{"word"} .= " *";
        }
        $obj{"word"} = FormatItem::DHde($obj{"word"});
    }
    # *** category layer b ***
    while ($data =~ s/<category.*?>(.+?)<\/category>//) {
        my %ctg = ();
        my $tmpCtg = $1;
        # ``` object have no sense```
        if ($tmpCtg !~ /<sense/) {
            $tmpCtg =~ s/<.+?>//g;
            ${$obj{"category"}[0]}{"sense"}{"def"} = $tmpCtg;
            return \%obj;
        }
        $tmpCtg =~ s/<sense.*?>(.*)<\/sense>//;
        # ```pos & gram```
        # 待仔细处理，标签里的内容
        while ($tmpCtg =~ s/<gram>(.+?)<\/gram>//) {
            $ctg{"gram"} .= $1;
            # last if $tmpCtg !~ /^<gram>/;
        }
        # ```variant```
        # while ($tmpCtg =~ s/<variant>(.+?)<\/variant>//) {
        #     $ctg{"variant"} .= "; ".FormatItem::DHde($1);
        #     $ctg{"variant"} =~ s/^; //;
        #     last if $tmpCtg !~ /^<variant>/;
        # }
        # ```variant```
        while ($tmpCtg =~ s/<variant>(.+?)<\/variant>//) {
            if (exists $ctg{"variant"}) {
                say $1;
            }
            $ctg{"variant"} .= "; ".FormatItem::DHde($1);
            $ctg{"variant"} =~ s/^; //;
            last if $tmpCtg !~ /^<variant>/;
        }

        # if ($tmpCtg =~ /</) {
        #     say $tmpCtg;exit;
        # }
        # *** sence layer c ***
        # while ($tmpCtg =~ s/<sense.*?>(.+?)<\/sense>//) {
        #     my %sen = ();
        #     $sen{"test"} = $1;
            
        #     # *** idiom ***
            
        #     push @{$ctg{"sense"}},\%sen;
        # }
        push @{$obj{"category"}},\%ctg;
    }
    # say $data;exit;
    
    return \%obj;
}

1;
